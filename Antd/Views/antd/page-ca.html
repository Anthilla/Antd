@Master['layout.html']
<!-------------------------------------------------------------------------------------
//     Copyright (c) 2014, Anthilla S.r.l. (http://www.anthilla.com)
//     All rights reserved.
//
//     Redistribution and use in source and binary forms, with or without
//     modification, are permitted provided that the following conditions are met:
//         * Redistributions of source code must retain the above copyright
//           notice, this list of conditions and the following disclaimer.
//         * Redistributions in binary form must reproduce the above copyright
//           notice, this list of conditions and the following disclaimer in the
//           documentation and/or other materials provided with the distribution.
//         * Neither the name of the Anthilla S.r.l. nor the
//           names of its contributors may be used to endorse or promote products
//           derived from this software without specific prior written permission.
//
//     THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
//     ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
//     WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
//     DISCLAIMED. IN NO EVENT SHALL ANTHILLA S.R.L. BE LIABLE FOR ANY
//     DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
//     (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
//     LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
//     ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
//     (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
//     SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
//
//     20141110
//------------------------------------------------------------------------------------->
@Section['PageBar']
<style type="text/css">
    #Ca-TB {
        background-color: #A7BD39 !important;
        color: #3a3a3a !important;
        border-color: #A7BD39 !important;
    }

    div.row {
        margin-top: 20px !important;
    }

        #BottomContent {
        padding: 0 !important;
        border-top-color: #3a3a3a;
        border-top-width: 4px;
    }
</style>
@EndSection

@Section['MainContent']
<nav class="vertical-menu">
    <ul class="bg-anthilla-gray fg-anthilla-green" style="width: 15%; padding: 5px 15px; margin-left: 0 !important; margin-top: 0 !important; float: left;">
        <li>
            <a href="#" data-role="load-page" data-page="ca/setup" class="fg-hover-white upcase">Certificate Authority
                <i data-icon="load" class="icon-loading-2 on-right fg-white rotating" style="display: none !important"></i>
            </a>
        </li>
        <li style="padding-left: 15px;">
            <a href="#" data-role="load-page" data-page="ca/cert" class="fg-hover-white capitalize">Certificate
                <i data-icon="load" class="icon-loading-2 on-right fg-white rotating" style="display: none !important"></i>
            </a>
        </li>
        <li style="padding-left: 15px;">
            <a href="#" data-role="load-page" data-page="ca/certdc" class="fg-hover-white capitalize">Certificate for D.C.
                <i data-icon="load" class="icon-loading-2 on-right fg-white rotating" style="display: none !important"></i>
            </a>
        </li>
        <li style="padding-left: 15px;">
            <a href="#" data-role="load-page" data-page="ca/certsc" class="fg-hover-white capitalize">Certificate for SmartCard
                <i data-icon="load" class="icon-loading-2 on-right fg-white rotating" style="display: none !important"></i>
            </a>
        </li>
        <li>
            <a href="#" data-role="load-page" data-page="ca/dc" class="fg-hover-white upcase">Domain Controller
                <i data-icon="load" class="icon-loading-2 on-right fg-white rotating" style="display: none !important"></i>
            </a>
        </li>
        <li style="padding-left: 15px;">
            <a href="#" data-role="load-page" data-page="ca/dcusers" class="fg-hover-white capitalize">Users
                <i data-icon="load" class="icon-loading-2 on-right fg-white rotating" style="display: none !important"></i>
            </a>
        </li>
    </ul>
</nav>
<div data-role="page-container" style="min-height: 250px; float: right; width: 85%;">
</div>
@EndSection

@Section['Scripts']
<script data-context="general" type="text/javascript">
    $(document).on("ready", function () {
        $('div[data-role="hide-selectize"]').find('#show-units').hide();
    });

    $('#ReloadSystemInfo').on("click", function () {
        jQuery.support.cors = true;
        var aj = $.ajax({
            url: '/system/import/info',
            type: 'POST',
            success: function () {
                location.reload(true);
            }
        });
        _requests.push(aj);
    });

    $('.search-field').keyup(function () {
        var context = $(this).attr('data-searchable');
        var queryString = $(this).val();
        var tableBody = $('.searchable[data-searchable="' + context + '"]').find('tbody');
        var row = tableBody.children('tr');
        row.each(function () {
            var thisRow = $(this);
            var queriedText = $(this).text();
            if (queriedText.indexOf(queryString) !== -1) {
                thisRow.show();
            }
            if (queriedText.indexOf(queryString) < 0) {
                thisRow.hide();
            }
        });
    });

    $(document).on("ready", function () {
        $.when(
            LoadUserEntitiesUnits()
        ).then();
    });

    var UserSelectizerOptions = function () {
        return {
            load: function (query, callback) {
                if (!query.length) return callback();
                var aj = $.ajax({
                    url: this.settings.remoteUrl,
                    type: "GET",
                    dataType: "json",
                    data: {
                        s: query
                    },
                    error: function () {
                        callback();
                    },
                    success: function (data) {
                        callback(data);
                    }
                });
                _requests.push(aj);
                return callback;
            },
            render: function (data, escape) {
                return '<div><span data-guid="' + escape(data.guid) + '" class="button name bg-anthilla-violet">' + String(data.alias) + "</span></div>";
            }
        };
    }();

    var $userEntitiesSelectizer = $("#userEntities").selectize({
        delimiter: ",",
        persist: false,
        valueField: "guid",
        labelField: "alias",
        searchField: ["alias", "guid"],
        render: { option: UserSelectizerOptions.render },
        remoteUrl: "/users/json",
        load: UserSelectizerOptions.load,
        sortField: "alias"
    });

    function LoadUserEntitiesUnits() {
        if ($("#userEntities").size() > 0) {
            var userEntitiesSelectizer = $userEntitiesSelectizer[0].selectize;
            userEntitiesSelectizer.load(function (callback) {
                Callback(callback, this.settings.remoteUrl);
                $("#userEntities").hide();
            });
        }
    }

    //////////////////////////////////////////////////////////////////

    $('select[name="Assignment"]').focusout(function () {
        var selectedoption = $(this).find('option:selected').val();
        if (selectedoption === "user") {
            $('#UserAssignmentRow').show();
            $('#ServiceAssignmentRow').hide();
        }
        if (selectedoption === "service") {
            $('#UserAssignmentRow').hide();
            $('#ServiceAssignmentRow').show();
        }
    });

    $('select[name="Assignment"]').on("click", function () {
        var selectedoption = $(this).find('option:selected').val();
        if (selectedoption === "user") {
            $('#UserAssignmentRow').show();
            $('#ServiceAssignmentRow').hide();
        }
        if (selectedoption === "service") {
            $('#UserAssignmentRow').hide();
            $('#ServiceAssignmentRow').show();
        }
    });

    $('[data-role="CertificateAuthoritySetup"]').on("click", function () {
        jQuery.support.cors = true;
        var aj = $.ajax({
            url: '/ca/setup',
            type: 'POST',
            success: function () {
                location.reload(true);
            }
        });
        _requests.push(aj);
    });

    $('[data-role="CreateNewCertificate"]').on("click", function () {
        var name = $(this).prev('input[name="CertificateName"]').val();
        jQuery.support.cors = true;
        var aj = $.ajax({
            url: '/ca/certificate/new',
            type: 'POST',
            data: {
                Certificate: name
            },
            success: function () {
                location.reload(true);
            }
        });
        _requests.push(aj);
    });

    $('[data-role="InvertSslOption"]').on("click", function () {
        jQuery.support.cors = true;
        var aj = $.ajax({
            url: '/ca/ssl/toggle',
            type: 'POST',
            success: function () {
                location.reload(true);
            }
        });
        _requests.push(aj);
    });

    $('[data-role="ChangeCertificatePath"]').on("click", function () {
        var path = $(this).prev('input[name="CertificatePath"]').val();
        jQuery.support.cors = true;
        var aj = $.ajax({
            url: '/ca/cert/set',
            type: 'POST',
            data: {
                CertificatePath: path
            },
            success: function () {
                location.reload(true);
            }
        });
        _requests.push(aj);
    });

    $('[data-role="submit-general-function"]').on("click", function () {
        var command = $(this).attr('data-command');
        var param = $(this).prev('[data-role="input-general-function"]').val();
        jQuery.support.cors = true;
        var aj = $.ajax({
            url: '/terminal/direct/post',
            type: 'POST',
            data: {
                Command: command.replace("[tag:x]", param)
            },
            success: function () {
                location.reload(true);
            }
        });
        _requests.push(aj);
    });

    $('[data-role="submit-general-function-from-text"]').on("click", function () {
        var command = $(this).attr('data-command');
        var param = $(this).prev('[data-role="show-general-function"]').text();
        jQuery.support.cors = true;
        var aj = $.ajax({
            url: '/terminal/direct',
            type: 'POST',
            data: {
                Command: command.replace("[tag:x]", param)
            },
            success: function () {
                location.reload(true);
            }
        });
        _requests.push(aj);
    });

    $(document).on("ready", function () {
        $('textarea[data-role="show-general-function"]').each(function () {
            var t = $(this);
            var command = t.attr('data-command');
            jQuery.support.cors = true;
            var aj = $.ajax({
                url: '/terminal/direct',
                type: 'POST',
                data: {
                    Command: command
                },
                success: function (data) {
                    t.text(data);
                }
            });
            _requests.push(aj);
        });
        $('select[data-role2="show-general-function"]').each(function () {
            var t = $(this);
            var command = t.attr('data-command');
            jQuery.support.cors = true;
            var aj = $.ajax({
                url: '/terminal/direct',
                type: 'POST',
                data: {
                    Command: command
                },
                success: function (data) {
                    var arr = data.split('\n');
                    $.each(arr, function (i, value) {
                        t.append('<option Value="' + value + '">' + value + '</option>');
                    });
                }
            });
            _requests.push(aj);
        });
    });

    $('p.edit-conf').on("click", function () {
        var path = $(this).attr('data-path');
        jQuery.support.cors = true;
        var aj = $.ajax({
            url: '/system/read/file/' + path,
            type: 'GET',
            dataType: 'json',
            contentType: 'application/json;charset=utf-8',
            success: function (text) {
                var dashboard = $('#FileConfigDashboard');
                dashboard.find('#title').text('Editing: ' + path);
                dashboard.find('input[name="FilePath"]').val(path);
                dashboard.find('textarea[name="FileContent"]').text(text);
                dashboard.show();
                //todo scrollup to dashboard
                return false;
            }
        });
        _requests.push(aj);
    });

    $('p.export-conf').on("click", function () {
        var p = $(this).attr('data-path');
        jQuery.support.cors = true;
        var aj = $.ajax({
            url: '/system/export/file/' + p,
            type: 'POST',
            data: JSON.stringify(p),
            contentType: "application/json;charset=utf-8",
            success: function () {
                location.reload(true);
                return false;
            }
        });
        _requests.push(aj);
    });

    $('input#close').on("click", function () {
        var form = $('form');
        form.find('input').val('');
        form.find('textarea').text('');
        form.hide();
    });

    $('input#clear').on("click", function () {
        var form = $('form');
        form.find('input').val('');
        form.find('textarea').text('');
    });
</script>

@EndSection